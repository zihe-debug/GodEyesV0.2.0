const w={debug:(...e)=>console.debug("[Scanner]",...e),info:(...e)=>console.info("[Scanner]",...e),warn:(...e)=>console.warn("[Scanner]",...e),error:(...e)=>console.error("[Scanner]",...e)};typeof window<"u"&&(window.logger=w);const c={API:{PATTERN:/['"`](?:\/|\.\.\/|\.\/)[^\/\>\< \)\(\}\,\'\"\\](?:[^\^\>\< \)\(\,\'\"\\])*?['"`]|['"`][a-zA_Z0-9]+(?<!text|application)\/(?:[^\^\>\< \)\(\{\}\,\'\"\\])*?["'`]/g,IMAGE_PATTERN:/\.(jpg|jpeg|png|gif|bmp|webp|svg|ico|mp3|mp4|m4a|wav|swf)(?:\?[^'"]*)?$/i,JS_PATTERN:/\.(js|jsx|ts|tsx|less)(?:\?[^'"]*)?$/i,DOC_PATTERN:/\.(pdf|doc|docx|xls|xlsx|ppt|exe|apk|zip|7z|dll|dmg|pptx|txt|rar|md|csv)(?:\?[^'"]*)?$/i,FONT_PATTERN:/\.(ttf|eot|woff|woff2|otf|css)(?:\?[^'"]*)?$/i,SKIP_JS_PATTERNS:[/^jquery([.-]?\d*\.?\d*\.?\d*)?(?:[\.-]cookie)?(?:[\.-]fancybox)?(?:[\.-]validate)?(?:[\.-]artDialog)?(?:[\.-]blockui)?(?:[\.-]pack)?(?:[\.-]base64)?(?:[\.-]md5)?(?:[\.-]min)?\.js$/i,/^(?:vue|vue-router|vuex)[.-]?\d*\.?\d*\.?\d*(?:\.min)?\.js$/i,/^(react|react-dom)[.-]?\d*\.?\d*\.?\d*(?:\.min)?\.js$/i,/^bootstrap(?:\.bundle)?[.-]?\d*\.?\d*\.?\d*(?:[\.-]datepicker|datetimepicker)?(?:[\.-]zh-CN)?(?:[\.-]min)?\.js$/i,/^(layui|lay|layer|liger|h-ui|element-ui|ueditor|kindeditor|ant-design)[.-]?\d*\.?\d*\.?\d*(?:[\.-]all)?(?:\.admin)?(?:[\.-]config)?(?:[\.-]min)?\.js$/i,/^(echarts|chart|highcharts)[.-]?\d*\.?\d*\.?\d*(?:\.min)?\.js$/i,/^(lodash|moment|katex|tableexport|axios|plupload|pqgrid|md5)[.-]?\d*\.?\d*\.?\d*(?:\.full)?(?:\.min)?\.js$/i,/^(polyfill|modernizr|device|less|isotope.pkgd|lhgdialog|kendo.web|dataTables|editor|seajs-style|seajs-text|tinymce|jsencrypt|backbone|select2|underscore|ext-all|ext-unigui-min|exporter|buttons|v5_float_4)[.-]?\d*\.?\d*\.?\d*(?:[\.-]dev)?(?:[\.-]html5|bootstrap|print|full)?(?:[\.-]min)?\.js$/i,/^(datepicker|datetimepicker|wdatepicker|laydate)[.-]?\d*\.?\d*\.?\d*(?:\.min)?\.js$/i,/^(?:zh|en|zh-cn|zh-tw|ja|ko)[.-]?\d*\.?\d*\.?\d*(?:\.min)?\.js$/i],FILTERED_CONTENT_TYPES:["multipart/form-data","node_modules/","pause/break","partial/ajax","chrome/","firefox/","edge/","examples/element-ui","static/js/","static/css/","stylesheet/less","jpg/jpeg/png/pdf","yyyy/mm/dd","dd/mm/yyyy","mm/dd/yy","yy/mm/dd","m/d/Y","m/d/y","xx/xx","zrender/vml/vml"]},DOMAIN:{BLACKLIST:["el.datepicker.today","obj.style.top","window.top","mydragdiv.style.top","container.style.top","location.host","page.info","res.info","item.info"]},IP:{SPECIAL_RANGES:[/^0\.0\.0\.0$/,/^255\.255\.255\.255$/]},PATTERNS:{DOMAIN:/\b(?:(?!this)[a-z0-9%-]+\.)*?(?:(?!this)[a-z0-9%-]{2,}\.)(?:wang|club|xyz|vip|top|beer|work|ren|technology|fashion|luxe|yoga|red|love|online|ltd|chat|group|pub|run|city|live|kim|pet|space|site|tech|host|fun|store|pink|ski|design|ink|wiki|video|email|company|plus|center|cool|fund|gold|guru|life|team|today|world|zone|social|bio|black|blue|green|lotto|organic|poker|promo|vote|archi|voto|fit|cn|website|press|icu|art|law|shop|band|media|cab|cash|cafe|games|link|fan|net|cc|com|fans|cloud|info|pro|mobi|asia|studio|biz|vin|news|fyi|tax|tv|market|shopping|mba|sale|co|org)(?:\:\d{1,5})?(?![a-zA-Z0-9._=>\(\);!}-])\b/g,DOMAIN_RESOURCE:/["'](?:(?:[a-z0-9]+:)?\/\/)?(?:(?!this)[a-z0-9%-]+\.)*?(?:[a-z0-9%-]{2,}\.)(?:wang|club|xyz|vip|top|beer|work|ren|technology|fashion|luxe|yoga|red|love|online|ltd|chat|group|pub|run|city|live|kim|pet|space|site|tech|host|fun|store|pink|ski|design|ink|wiki|video|email|company|plus|center|cool|fund|gold|guru|life|team|today|world|zone|social|bio|black|blue|green|lotto|organic|poker|promo|vote|archi|voto|fit|cn|website|press|icu|art|law|shop|band|media|cab|cash|cafe|games|link|fan|net|cc|com|fans|cloud|info|pro|mobi|asia|studio|biz|vin|news|fyi|tax|tv|market|shopping|mba|sale|co|org)(?![a-zA-Z0-9.])(?:\:\d{1,5})?\S*?["']/g,DOMAIN_FILTER:/\b(?:[a-zA-Z0-9%-]+\.)+[a-z]{2,10}(?:\:\d{1,5})?\b/,IP:/(?<!\.|\d)(?:(?:25[0-5]|2[0-4]\d|1\d{2}|[1-9]?\d)\.){3}(?:25[0-5]|2[0-4]\d|1\d{2}|[1-9]?\d)(?::\d{1,5})?(?!\.|[0-9])/g,IP_RESOURCE:/["'](?:(?:[a-zA-Z0-9%-]+\:)?\/\/)?(?:(?:25[0-5]|2[0-4]\d|1\d{2}|[1-9]?\d)\.){3}(?:25[0-5]|2[0-4]\d|1\d{2}|[1-9]?\d)(?::\d{1,5}|\/)?\S*?["']/g,get API(){return c.API.PATTERN},PHONE:/(?<!\d|\.)(?:13[0-9]|14[01456879]|15[0-35-9]|16[2567]|17[0-8]|18[0-9]|19[0-35-9]|198|199)\d{8}(?!\d)/g,EMAIL:/[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+(?!\.png)\.[a-zA-Z]{2,}(?:\.[a-zA-Z]{2,})?/g,IDCARD:/(?:\d{6}(?:19|20)(?:0\d|10|11|12)(?:[0-2]\d|30|31)\d{3}$)|(?:\d{6}(?:18|19|20)\d{2}(?:0[1-9]|10|11|12)(?:[0-2]\d|30|31)\d{3}(?:\d|X|x))(?!\d)/g,URL:/(?:https?|wss?|ftp):\/\/(?:(?:[\w-]+\.)+[a-z]{2,}|(?:\d{1,3}\.){3}\d{1,3})(?::\d{2,5})?(?:\/[^\s\>\)\}\<'"]*)?/gi,JWT:/["'](?:ey[A-Za-z0-9_-]{10,}\.[A-Za-z0-9._-]{10,}|ey[A-Za-z0-9_\/+-]{10,}\.[A-Za-z0-9._\/+-]{10,})["']/g,COMPANY:/(?:[\u4e00-\u9fa5\（\）]{4,15}[^的](?:公司|中心)|[\u4e00-\u9fa5\（\）]{2,10}[^的](?:软件)|[\u4e00-\u9fa5]{2,15}(?:科技|集团))(?!法|点|与|查)/g,GITHUB:/(?:https?:\/\/)?(?:www\.)?github\.com\/[a-zA-Z0-9._-]+\/[a-zA-Z0-9._-]+/gi,FINGER:{patterns:[{class:"Webpack",name:"Webpack页面特征",pattern:/(?:webpackJsonp|__webpack_require__|webpack-dev-server)/i,description:"构建工具，用于前端资源打包",type:"builder"},{class:"Webpack",name:"Webpack文件特征",pattern:/(?:chunk|main|app|vendor|common)s?(?:[-.][a-f0-9]{8,20})+.(?:css|js)/i,description:"构建工具，用于前端资源打包",type:"builder"},{class:"VisualStudio",name:"Visual Studio页面特征",pattern:/visual\sstudio/i,description:"开发工具，用于网页开发",type:"builder"},{class:"Cloudflare CDN",name:"页面特征",pattern:/cdnjs.cloudflare.com/i,description:"服务，用于网页加速",type:"cdn"},{class:"jsDelivr CDN",name:"页面特征",pattern:/cdn.jsdelivr.net/i,description:"服务，用于网页加速",type:"cdn"},{class:"Django",name:"页面特征",pattern:/csrfmiddlewaretoken/i,description:"框架",type:"framework",extType:"technology",extName:"Python"}]},CREDENTIALS:{patterns:[{name:"用户密码模式1",pattern:/['"]\w*(?:pwd|pass|user|member|account|password|passwd|admin|root|system)[_-]?(?:id|name)?[0-9]*["']\s*[:=]\s*(?:['"][^\,\s\"\(]*["'])/gi},{name:"用户密码模式2",pattern:/\w*(?:pwd|pass|user|member|account|password|passwd|admin|root|system)[_-]?(?:id|name)?[0-9]*\s*[:=]\s*(?:['"][^\,\s\"\(]*["'])/gi},{name:"用户密码模式3",pattern:/['"]\w*(?:pwd|pass|user|member|account|password|passwd|admin|root|system)[_-]?(?:id|name)?[0-9]*\s*[:=]\s*(?:[^\,\s\"\(]*)["']/gi}]},ID_KEY:{patterns:[{name:"微信开放平台密钥",pattern:/wx[a-z0-9]{15,18}/g},{name:"AWS密钥",pattern:/AKIA[0-9A-Z]{16}/g},{name:"阿里云密钥",pattern:/LTAI[A-Za-z\d]{12,30}/g},{name:"Google API密钥",pattern:/AIza[0-9A-Za-z_\-]{35}/g},{name:"腾讯云密钥",pattern:/AKID[A-Za-z\d]{13,40}/g},{name:"京东云密钥",pattern:/JDC_[0-9A-Z]{25,40}/g},{name:"其他AWS密钥",pattern:/(?:A3T[A-Z0-9]|AKIA|AGPA|AIDA|AROA|AIPA|ANPA|ANVA|ASIA)[A-Z0-9]{16}/g},{name:"支付宝开放平台密钥",pattern:/(?:AKLT|AKTP)[a-zA-Z0-9]{35,50}/g},{name:"GitLab Token1",pattern:/glpat-[a-zA-Z0-9\-=_]{20,22}/g},{name:"GitHub Token2",pattern:/(?:ghp|gho|ghu|ghs|ghr|github_pat)_[a-zA-Z0-9_]{36,255}/g},{name:"Apple开发者密钥",pattern:/APID[a-zA-Z0-9]{32,42}/g},{name:"企业微信密钥",pattern:/ww[a-z0-9]{15,18}/g},{name:"key1",pattern:/(?:['"]?(?:[\w-]*(?:secret|oss|bucket|key)[\w-]*)|ak["']?)\s*[:=]\s*(?:"(?!\+)[^\,\s\"\(\>\<]{6,}"|'(?!\+)[^\,\s\'\(\>\<]{6,}'|[0-9a-zA-Z_-]{16,})/ig},{name:"key2",pattern:/["'][a-zA-Z0-9]{32}["']/g}]}}},A={SHORT_VALUES:new Set(["up","in","by","of","is","on","to","no","age","all","app","ang","bar","bea","big","bug","can","com","con","cry","dom","dow","emp","ent","eta","eye","for","get","gen","has","hei","hid","ing","int","ken","key","lea","log","low","met","mod","new","nor","not","num","red","obj","old","out","pic","pre","pro","pop","pun","put","rad","ran","ref","red","reg","ren","rig","row","sea","set","seq","shi","str","sub","sup","sun","tab","tan","tip","top","uri","url","use","ver","via","rce","sum","bit","kit","uid"]),MEDIUM_VALUES:new Set(["null","node","when","face","read","load","body","left","mark","down","ctrl","play","ntal","head","item","init","hand","next","nect","json","long","slid","less","view","html","tion","rect","link","char","core","turn","atom","tech","type","main","size","time","full","card","more","wrap","this","tool","late","note","leng","area","bool","pick","parm","axis","high","true","date","tend","work","lang","func","able","dark","term","info","data","opts","self","void","pace","list","brac","cret","tive","sult","text","stor","back","port","case","pare","dent","blot","fine","reif","cord","else","fail","rend","leav","hint","coll","move","with","base","rate","name","hile","lete","post","pect","icon","auth","jump","wave","land","wood","lize","room","chat","user","vice","ress","line","send","mess","calc","http","rame","rest","last","guar","iate","ment","task","stat","fill","coun","faul","rece","arse","exam","good","gest","word","cast","lock","slot","fund","plus","thre","sign","pack","reak","code","tent","math","lect","draw","lend","glow","past","blue","dial","purp"]),LONG_VALUES:new Set(["about","alias","apply","array","basic","beare","begin","black","break","broad","catch","class","close","clear","click","clude","color","count","cover","croll","crypt","error","false","fault","fetch","final","found","gener","green","group","guard","index","inner","input","inter","light","login","opera","param","parse","panel","place","print","phony","radio","range","right","refer","serve","share","shift","style","tance","title","token","tract","trans","trave","valid","video","white","write","button","cancel","create","double","finger","global","insert","module","normal","object","popper","triple","search","select","simple","single","status","statis","switch","system","visual","verify","detail","screen","member","change","buffer","grade"]),CHINESE_BLACKLIST:new Set(["请","输入","前往","整个","常用","咨询","为中心","是否","以上","目前","任务","或者","推动","需要","直接","识别","获取","用于","清除","遍历","使用","是由","您","用户","一家","项目","等","造价","判断","通过","为了","可以","掌握","传统","杀毒","允许","分析","包括","很多","接","未经","方式","些","的","第三方","因此","形式","任何","提交","多数","其他","执行","操作","维护","或","其它","分享","导致","一概","所有","及其","以及","应当","条件","除非","否则","违反","将被","提供","无法","建立","打造","帮助","依法","鉴于","快速","构建","是","在","去","恶意","挖矿","流氓","勒索","依靠","基于","通常","这","个","没有","并","、","，","查看","确保","提高","减少","检查","更新","卸载","常见","依赖","进行","测试","作弊"," "]),KEY_BLACKLIST:new Set(["size","row","dict","up","highlight","cabin","cross","time"])};typeof window<"u"&&(window.SCANNER_CONFIG=c);const _={coordPattern:/^coord/,valuePattern:/^\/|true|false|register|signUp|basic|http/i,chinesePattern:/^[\u4e00-\u9fa5]+$/,camelCasePattern:/\b[_a-z]+(?:[A-Z][a-z]+)+\b/},S={api:(function(){return function(e,n,t){if(e=e.slice(1,-1),c.API.FONT_PATTERN.test(e))return!1;if(e.endsWith(".vue"))return t?.vueFiles?.set(e,n),!0;if(c.API.IMAGE_PATTERN.test(e))return t?.imageFiles?.set(e,n),!0;if(c.API.JS_PATTERN.test(e))return t?.jsFiles?.set(e,n),!0;if(c.API.DOC_PATTERN.test(e))return t?.docFiles?.set(e,n),!0;const a=e.toLowerCase();if(c.API.FILTERED_CONTENT_TYPES.some(s=>a===s.toLowerCase()))return!1;if(e.startsWith("./"))return t?.moduleFiles?.set(e,n),!0;if(e.startsWith("/")){if(e.length<=4&&/[A-Z\.\/\#\+\?23]/.test(e.slice(1)))return!1;t?.absoluteApis?.set(e,n)}else{if(/^(audio|blots|core|ace|icon|css|formats|image|js|modules|text|themes|ui|video|static|attributors|application)/.test(e)||e.length<=4)return!1;t?.apis?.set(e,n)}return!0}})(),domain:(function(){const e=new Map,n={clean(t){try{if(t=t.replace(/^['"]|['"]$/g,""),t=t.toLowerCase(),e.has(t))t=e.get(t);else try{const r=decodeURIComponent(t.replace(/\+/g," "));e.set(t,r),t=r}catch{e.set(t,t)}const a=t.match(c.PATTERNS.DOMAIN_FILTER);if(a&&/\b[a-z]+\.(?:top|bottom)-[a-z]+\.top\b/.test(a[0]))return!1;if(a&&a[0].split(".")[0]!=="el"&&a[0].split(".")[0]!=="e")t=a[0];else return!1;return t}catch{return!1}},notInBlacklist(t){return!c.DOMAIN.BLACKLIST.some(a=>t.includes(a))}};return function(t,a,r){const s=n.clean(t);return!s||!n.notInBlacklist(s)?!1:(r?.domains?.set(s,a),!0)}})(),ip:(function(){const e={notSpecial(n){return!c.IP.SPECIAL_RANGES.some(t=>t.test(n))}};return function(n,t,a){n=n.replace(/^[`'"]|[`'"]$/g,"");const r=n.match(c.PATTERNS.IP);if(r){const s=r[0];if(!e.notSpecial(s))return!1;a?.ips?.set(s,t)}return!0}})(),phone:(e,n,t)=>(t?.phones?.set(e,n),!0),email:(e,n,t)=>(t?.emails?.set(e,n),!0),idcard:(e,n,t)=>(t?.idcards?.set(e,n),!0),url:(e,n,t)=>{try{if(e.toLowerCase().includes("github.com/"))return t?.githubUrls?.set(e,n),!0;t?.urls?.set(e,n);const a=new URL(e),r=window.location.host;if(a.host===r){const s=a.pathname;if(c.API.FONT_PATTERN.test(s))return!1;if(c.API.IMAGE_PATTERN.test(s))return t?.imageFiles?.set(s,n),!0;if(c.API.JS_PATTERN.test(s))return t?.jsFiles?.set(s,n),!0;if(c.API.DOC_PATTERN.test(s))return t?.docFiles?.set(s,n),!0;if(!s.match(/\.[a-zA-Z0-9]+$/))return s.startsWith("/")?t?.absoluteApis?.set(s,n):t?.apis?.set(s,n),!0}}catch(a){console.error("Error processing URL:",a)}return!0},jwt:(e,n,t)=>(t?.jwts?.set(e,n),!0),company:(e,n,t)=>/[（）]/.test(e)&&!e.match(/（\S*）/)||Array.from(A.CHINESE_BLACKLIST).some(a=>e.includes(a))?!1:(t?.companies?.set(e,n),!0),credentials:(e,n,t)=>{const a=e.replace(/\s+/g,"").split(/[:=]/),r=a[0].replace(/['"]/g,"").toLowerCase(),s=a[1].replace(/['"\{\}\[\]\，\：\。\？\、\?\!\>\<]/g,"").toLowerCase();return!s.length||_.coordPattern.test(r)||_.valuePattern.test(s)||s.length<=1||_.chinesePattern.test(s)?!1:(t?.credentials?.set(e,n),!0)},cookie:(e,n,t)=>{const a=e.replace(/\s+/g,"").split(/[:=]/);if(a[1].replace(/['"]/g,"").length<4)return!1;const r=a[0].replace(/['"<>]/g,"").toLowerCase(),s=a[1].replace(/['"<>]/g,"").toLowerCase();if(!s.length||r===s)return!1;if(s.length<12){if(Array.from(A.SHORT_VALUES).some(i=>s.includes(i)))return!1}else if(Array.from(A.MEDIUM_VALUES).some(i=>s.includes(i)))return!1;return t?.cookies?.set(e,n),!0},id_key:(e,n,t)=>{const a=e.match(/[:=]/);if(a||e.length>=32){if(a){const r=e.replace(/\s+/g,"").split(/[:=]/),s=r[0].replace(/['"<>]/g,""),i=r[1].replace(/['"><]/g,""),o=s.toLowerCase(),l=i.toLowerCase();if(!i.length||o===l||Array.from(A.KEY_BLACKLIST).some(u=>o.includes(u)))return!1;if(i.length<16){if(Array.from(A.SHORT_VALUES).some(u=>l.includes(u))||Array.from(A.MEDIUM_VALUES).some(u=>l.includes(u)))return!1}else if(Array.from(A.MEDIUM_VALUES).some(u=>l.includes(u))||Array.from(A.LONG_VALUES).some(u=>l.includes(u)))return!1;if(s==="key"&&(i.length<=8||_.camelCasePattern.test(i))||i.length<=3)return!1}else if(/^[a-zA-Z]+$/.test(e.slice(1,-1))||Array.from(A.MEDIUM_VALUES).some(r=>e.includes(r))||Array.from(A.LONG_VALUES).some(r=>e.includes(r)))return!1;return t?.idKeys?.set(e,n),!0}return!1},finger:(e,n,t,a,r,s,i,o)=>{const l={type:t,name:n,description:`通过${e}识别到${n}${a}`,version:n,extType:i,extName:o};return chrome.runtime.sendMessage({type:"UPDATE_BUILDER",finger:l,from:"content",to:"background"}),s?.fingers?.set(n,r),!0}};typeof window<"u"&&(window.SCANNER_FILTER=S);let R=!1,N=!1,g=null,L=null,U=!1,O=new Set,T=null,v=null,P=!1;const M={},I=[],C=new Set,F=new Map,k=new Set,b=new Map,q=10,E=5e4;typeof window<"u"&&(window.SCANNER_CONFIG=c,window.SCANNER_FILTER=S,window.logger=w);async function Z(){return new Promise(e=>{chrome.storage.local.get(["dynamicScan","deepScan","customWhitelist"],async n=>{v=window.location.hostname.toLowerCase(),R=n.dynamicScan===!0,N=n.deepScan===!0;let t=null;t=v,T===null&&(T=n.customWhitelist?.some(a=>t===a||t.endsWith(`.${a}`))),chrome.runtime.sendMessage({type:"REGISTER_CONTENT",from:"content",to:"background"},a=>{T||(O=new Set(a.tabJs),g=a.tabId,g!==null&&J(g),O.forEach(r=>{x(r,"background")}))}),e()})})}const Q=()=>{const e=["SCANNER_CONFIG","SCANNER_FILTER","logger"];return new Promise(n=>{(function t(){e.every(a=>window[a])?n():setTimeout(t,20)})()})},ee=()=>new Promise(e=>{chrome.runtime.sendMessage({type:"GET_TAB_ID",from:"content",to:"background"},n=>{g=n.tabId,g!==null&&e(g)})}),te=e=>{const n=e.split("/").pop()?.split("?")[0]?.toLowerCase()||"";return c.API.SKIP_JS_PATTERNS.some(t=>t.test(n))};function W(e){let t=new URL(e).pathname.split("/");return t.pop(),t.join("/")+"/"}function ne(e){const n=e.split("/").filter(Boolean);let t=M;return n.forEach(a=>{t[a]||(t[a]={}),t=t[a]}),M}function G(e,n,t=""){for(const a in e){const r=t+"/"+a;if(a===n.split("/")[1])return r;const s=G(e[a],n,r);if(s)return s}return""}function x(e,n="page",t=""){if(!C.has(e)&&!te(e)&&!T){const a=e.split("/").pop()?.split("?")[0],r=new URL(e).pathname,s=W(e),i=F.get(a);if(n==="page"&&N){if(i&&i.includes(r))return;if(!i&&t){let o=G(M,s)?.split("/");if(o){o.pop();let l=o.join("/")+s;e=e.replace(s,l)}}}ne(s),F.set(a,r),C.add(e),I.push(e),S.url(e,"暂无法展示来源",b.get(g)),V()}}function*K(e){if(e.length<=E){yield e;return}const n=e.split(/\r?\n/);let t=[],a=0;for(const r of n){if(r.length>E){const i=r.split(/;/).map(o=>o.endsWith(";")?o:o+";");for(const o of i)if(o.length>E)for(let l=0;l<o.length;l+=E)yield o.slice(l,l+E);else{const l=o.length+1;a+l>E&&a>0&&(yield t.join(`
`)+`
`,t=[],a=0),t.push(o),a+=l}continue}const s=r.length+1;a+s>E&&a>0&&(yield t.join(`
`)+`
`,t=[],a=0),t.push(r),a+=s}t.length>0&&(yield t.join(`
`)+`
`)}const ae=async(e,n=!1,t)=>{const a=Object.entries(c.PATTERNS),r=b.get(g);let s=!1;for(const[i,o]of a){const l=S[i.toLowerCase()];if(!l)continue;let u,h=0,y=1e4;try{if(i==="FINGER"){for(const{pattern:d,name:p,class:m,type:z,description:H,extType:Y,extName:X}of o.patterns){if(r.fingers.has(m))continue;e.match(d)&&l(p,m,z,H,t,r,Y,X)&&(s=!0)}continue}if(i==="CREDENTIALS"||i==="ID_KEY"||i==="EMAIL"||i==="API"||i==="IP"||i==="DOMAIN"){let d=[];i==="IP"?n?d=[{pattern:o.toString()}]:d=[{pattern:c.PATTERNS.IP_RESOURCE.toString()}]:i==="DOMAIN"?n?d=[{pattern:o.toString()}]:d=[{pattern:c.PATTERNS.DOMAIN_RESOURCE.toString()}]:i==="EMAIL"?d=[{pattern:c.PATTERNS.EMAIL.toString()}]:i==="API"?d=[{pattern:c.API.PATTERN.toString()}]:d=o.patterns.map(p=>({pattern:p.pattern.toString()}));try{const p=await new Promise(m=>{chrome.runtime.sendMessage({type:"REGEX_MATCH",from:"content",to:"background",chunk:e,patterns:d,patternType:i},m)});p&&p.matches.length>0&&p.matches.forEach(({match:m})=>{l(m,t,r)&&(s=!0)})}catch(p){w.error("CREDENTIALS匹配出错:",p)}continue}const f=o;for(;(u=f.exec(e))!==null;){if(f.lastIndex<=h){w.warn(`检测到可能的无限循环: ${o}`);break}if(h=f.lastIndex,--y<=0){w.warn(`达到最大迭代次数: ${i}`);break}if(l(u[0],t,r)&&(s=!0),!f.global)break}}catch(f){w.error(`匹配${i}出错:`,f)}}return s},B=(e,n=!1)=>{const t=new Set,a=window.location.origin,r=/['"](?:[^'"]+\.(?:js)(?:\?[^\s'"]*)?)['"]/g,s=/{(?:"?[0-9a-z-~_]*"?:"?[0-9a-z-_~]{1,}"?,?){1,}}[+|()\[\]\{\}a-z]*"[a-z0-9-_.]*.js"/i,i=/("[a-z/]*"?)[+|()\[\]\{\}a-z]*(?:{(?:"?[0-9a-z-_~]*"?:"?[0-9a-z-_~]{1,}"?,?){1,}})?[+|()\[\]\{\}a-z]*\+?"."?\+?\(?{(?:"?[0-9a-z-_~]*"?:"?[0-9a-z-_~]{1,}"?,?){1,}}[+|()\[\]\{\}a-z]*("[a-z0-9-_.]*.js")/i,o=/"?[0-9a-z-~_]*"?\s*:\s*"?[0-9a-z-~_]*"?/ig;for(const l of K(e)){let u=null;if(P||(u=l.match(i)),u&&!P){P=!0;let h=u[1].slice(1,-1),y=u[2].slice(1,-1);h.startsWith("/")||(h="/"+h),h.endsWith("/")||(h=h+"/");let f=u[0].match(s);f&&Array.from(f[0].matchAll(o)).forEach(d=>{let p=d[0].split(":")[0];(p.includes('"')||p.includes("'"))&&(p=p.slice(1,-1));let m=d[0].split(":")[1];(m.includes('"')||m.includes("'"))&&(m=m.slice(1,-1),/^[a-z0-9]+$/.test(m)||(p=m,m=""));const z=a+h+p+(m?"."+m:"")+y;t.add(z)})}(!P&&N||n)&&Array.from(l.matchAll(r)).map(y=>{const f=y[0].slice(1,-1);let d=null;try{return f.startsWith("http")?d=f:f.startsWith("//")?d=window.location.protocol+f:f.startsWith("/")?d=a+f:d=new URL(f,a).href,d}catch(p){return console.error("Error processing JS path:",p),null}}).filter(y=>y!==null).forEach(y=>t.add(y))}return t};async function j(e,n=!1,t){try{for(const a of e)if(a)for(const r of K(a))await ae(r,n,t)&&D(),await new Promise(i=>setTimeout(i,0))}catch(a){a.message!=="Extension context invalidated."&&w.error("扫描出错:",a)}}const se=()=>{L&&clearTimeout(L),L=setTimeout(()=>{w.info("DOM变化触发重新扫描...");const e=document.documentElement.innerHTML;e&&j([e],!0,document.location.href)},1e3)};function J(e){b.has(e)||b.set(e,{domains:new Map,absoluteApis:new Map,apis:new Map,moduleFiles:new Map,docFiles:new Map,ips:new Map,phones:new Map,emails:new Map,idcards:new Map,jwts:new Map,imageFiles:new Map,jsFiles:new Map,vueFiles:new Map,urls:new Map,githubUrls:new Map,companies:new Map,credentials:new Map,cookies:new Map,idKeys:new Map,fingers:new Map,progress:new Map})}const re=new MutationObserver(e=>{if(!R)return;e.filter(t=>!(t.type==="attributes"&&(t.attributeName==="class"||t.attributeName==="style"))).length>0&&se()});async function $(){try{await Q(),g||await ee(),J(g),Object.keys(b.get(g)).forEach(a=>{b.get(g)[a].clear()});let e=null;if(e=v,T===null&&chrome.storage.local.get(["customWhitelist"],a=>{T=a.customWhitelist?.some(r=>e===r||e.endsWith(`.${r}`))}),T)return;const n=document.documentElement.innerHTML;n&&await j([n],!0,document.location.href);const t=B(n,!0);t.size>0&&t.forEach(a=>{a.startsWith("chrome-extension://")||x(a,"page")}),U||(re.observe(document.body,{childList:!0,subtree:!0,characterData:!0,attributeFilter:["src","href","data-*"],characterDataOldValue:!1}),U=!0)}catch(e){e.message!=="Extension context invalidated."&&w.error("初始化扫描出错:",e)}}const D=()=>{
  //console.log('[Content] 开始发送扫描更新'); // 添加日志信息
  try{
    const e={},n=C.size,t=I.length,a=k.size,r=n===0?100:Math.floor((n-t-a)/n*100);
    b.get(g).progress.set("percent",r);
    for(const s in b.get(g))e[s]=Array.from(b.get(g)[s]);
    //console.log('[Content] 准备发送SCAN_UPDATE消息, tabId:', g, 'frameUrl:', window.location.href); // 添加日志信息
    chrome.runtime.sendMessage({type:"SCAN_UPDATE",from:"content",to:"popup",results:e,tabId:g,frameUrl:window.location.href}).catch(()=>{
      console.log('[Content] 发送SCAN_UPDATE消息失败'); // 添加日志信息
    }),
    chrome.runtime.sendMessage({type:"UPDATE_BADGE",from:"content",to:"background",results:e,tabId:g,frameUrl:window.location.href}).catch(()=>{
      console.log('[Content] 发送UPDATE_BADGE消息失败'); // 添加日志信息
    })
  }catch(e){
    e.message!=="Extension context invalidated."&&w.error("发送更新出错:",e)
  }
};

async function V(){
  for(;I.length>0&&k.size<q;){
    const e=I.shift();
    k.add(e),ie(e).finally(()=>{k.delete(e),k.size===0&&D(),I.length>0&&V()}),await new Promise(n=>setTimeout(n,0))
  }
}

async function ie(e){
  try{
    const n=await new Promise(t=>{chrome.runtime.sendMessage({type:"FETCH_JS",url:e,from:"content",to:"background"},t)});
    if(n?.content){
      await j([n.content],!1,e);
      const t=B(n.content,!1);
      t&&t.forEach(a=>x(a,"page",W(e)))
    }
  }catch(n){
    console.error("处理 JS 出错:",e,n)
  }
}

chrome.runtime.onMessage.addListener((e,n,t)=>{
  //console.log('[Content] 收到消息:', e); // 添加日志信息
  try{
    switch(e.type){
      case"GET_RESULTS":{
        //console.log('[Content] 处理GET_RESULTS消息, tabId:', e.tabId); // 添加日志信息
        if(!b.get(e.tabId)){
          console.log('[Content] 未找到tabId对应的结果'); // 添加日志信息
          t(null);
          break
        }
        D(),
        t(null);
        break
      }
      case"REFRESH_SCAN":{
        console.log('[Content] 处理REFRESH_SCAN消息, tabId:', e.tabId); // 添加日志信息
        // 重新初始化扫描
        $();
        t({success: true});
        break
      }
      case"UPDATE_DYNAMIC_SCAN":{
        console.log('[Content] 处理UPDATE_DYNAMIC_SCAN消息, enabled:', e.enabled); // 添加日志信息
        R=!!e.enabled,
        t({success:!0});
        break
      }
      case"UPDATE_DEEP_SCAN":{
        console.log('[Content] 处理UPDATE_DEEP_SCAN消息, enabled:', e.enabled); // 添加日志信息
        N=!!e.enabled,
        t({success:!0});
        break
      }
      default:
        console.log('[Content] 未知消息类型，不处理'); // 添加日志信息
        t(null)
    }
  }catch(a){
    a.message!=="Extension context invalidated."&&w.error("处理消息出错:",a),
    t(null)
  }
  return!0
});

(async()=>document.readyState==="loading"?document.addEventListener("DOMContentLoaded",async()=>{await Z(),await $()}):(await Z(),await $()))();
